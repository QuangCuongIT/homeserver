<!DOCTYPE html>
<html>
<head>
	<style>
		*{
			box-sizing: border-box;
			padding: 0;
			margin: 0;
			font-family: 'poppins', sans-serif;
			font-size: 18px;
		}
		body{
			display: flex;
			align-items: left;
			justify-content: left;
		}
		.container{
			/* width: calc(var(--vh, 1vh) * 50); */
			width: 45%;
			padding: 30px;
			margin: 4px;
			border: 1px solid #eeeeee;
			border-radius: 10px;
			background-color: #04a346;
		}
		h4{
			margin-bottom: 10px;
			font-size: 24px;
			color: white;
		}
		input{
			width: 100%;
			padding: 10px;
			margin-bottom: 10px;
			border-radius: 5px;
		}
		select{
			width: 30%;
			padding: 10px;
			margin-bottom: 10px;
			border-radius: 5px;
		}
		textarea{
			width: 100%;
			padding: 10px;
			border-radius: 5px;
		}
		#submit{
			border: none;
			background-color: rgb(12, 80, 4);
			color: white;
			width: 30%;
			margin-top: 10px;
			border-radius: 5px;
		}
		#submit:hover{
			background-color: #0b3b06;
		}
		#message{
			color: white;
		}

		/* start spinning animation */
		.lds-dual-ring {
			/* change color here */
			color: white
		}
		.lds-dual-ring,
		.lds-dual-ring:after {
			box-sizing: border-box;
		}
		.lds-dual-ring {
			display: inline-block;
			width: 50px;
			height: 50px;
		}
		.lds-dual-ring:after {
			content: " ";
			display: block;
			width: 34px;
			height: 34px;
			margin: 8px;
			border-radius: 50%;
			border: 6.4px solid currentColor;
			border-color: currentColor transparent currentColor transparent;
			animation: lds-dual-ring 1.2s linear infinite;
		}
		@keyframes lds-dual-ring {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}
		/* end spinning animation */
	</style>
</head>
<body>
	<div class="container">
		<form method="post" action="" name="contact-form">
			<h4>Tiệm Giặt Sấy Ori</h4>
			<input id="name" type="text" name="Tên" placeholder="Tên nhân viên">
			<select name="Vào/Tan Ca" style="height: 50px">
				<option value="Vào Ca">Vào Ca</option>
				<option value="Tan Ca">Tan Ca</option>
			</select>

			<textarea name="Ghi chú của nhân viên (nếu có)" rows="4" placeholder="Ghi chú của nhân viên (nếu có)"></textarea>
			<input id="submitLocation" type="Nơi chấm công" name="Nơi chấm công" placeholder="Nơi chấm công" style="display: none">
			<div id="message" style="display: none;">
				<div id="successMsg">Xác nhận [status] thành công lúc [time] tại [shopName], định vị:</div>
				<a id="gmapUrl" href="" style="color: white"></a>
			</div>
			<input type="submit" value="Gửi" id="submit">
			<div id="spinning" class="lds-dual-ring" style="display: none;"></div>
		</form>
	</div>

	<script>
		const MAX_DISTANCE = 150; // meters
		const shopLocations = [
			{
				lat: 10.0416514, // shop 1 To Hien Thanh
				lng: 105.7553143
			},
			{
				lat: 10.0487630, // shop 2 Nguyen De
				lng: 105.7634580
			}
		]
		const shopCode2Name = {
			"6PDC2J" : "Tiệm 1",
			"UZ3JLR" : "Tiệm 2"
		};

		const scriptURL = 'https://script.google.com/macros/s/AKfycbwRQ_DwN5xaak--miZkQp-JCwiC2aQP8EHb93nxuwoaaAptkeoE57TlqDPHkYigLyUf/exec'

		const submitLocation = document.getElementById("submitLocation");
		const submitBtn = document.getElementById("submit");
		const form = document.forms['contact-form'];

		const urlParams = new URLSearchParams(window.location.search);
		const shopCode = urlParams.get('code');

		var previousName = localStorage.getItem("name");
		if (previousName !== undefined && previousName !== null && previousName.trim() !== "") {
			document.getElementById("name").value = previousName;
		}

		form.addEventListener('submit', e => {
			e.preventDefault();

			submitBtn.style.display = "none";
			document.getElementById("spinning").style.display = "block";

			getLocation()
		})

		function getLocation() {
			if (navigator.geolocation) {
				try {
					navigator.geolocation.getCurrentPosition(fillPositionAndSubmit);
				}
				catch(err) {
					// not sure this work
					alert("Không thể truy cập vị trí. Vui lòng cho phép truy cập.");
				}
			} else {
				// not sure this work
				alert("Thiết bị không hỗ trợ vị trí, vui lòng thử lại với trình duyệt khác (Safari, Chrome hoặc Firefox)");
			}
		}

		function fillPositionAndSubmit(position) {
			var curLat = position.coords.latitude;
			var curLng = position.coords.longitude;
			
			var googleMapUrl = 'https://maps.google.com/?q='+curLat+','+curLng+'';
			submitLocation.value = googleMapUrl;

			var formData = new FormData(form);

			if (shopCode === null || shopCode === undefined || shopCode.trim() === "" 
					|| shopCode2Name[shopCode] === null || shopCode2Name[shopCode] === undefined) {
				alert("QR sai, thiếu mã chi nhánh");
				window.location.reload();
				throw new Error('QR sai, thiếu mã chi nhánh');
			}
			formData.set('Chi nhánh', shopCode2Name[shopCode]);

			if (formData.get('Tên') === undefined || formData.get('Tên') === null || formData.get('Tên').trim() === "") {
				alert("Vui lòng điền Tên nhân viên");
				window.location.reload();
				throw new Error('Vui lòng điền Tên nhân viên');
			}

			// Verify device location
			var hasValidLocation = false;
			for (let i = 0; i < shopLocations.length; i++) {
				var shopLocation = shopLocations[i];
				var distance = calculateDistance(curLat, curLng, shopLocation.lat, shopLocation.lng); // meters
				if (distance < MAX_DISTANCE) {
					hasValidLocation = true;
				}
			}
			if (!hasValidLocation) {
				alert("Lỗi! Không thể chấm công từ xa. Vui lòng di chuyển tới tiệm.");
				window.location.reload();
				throw new Error('Lỗi! Không thể chấm công từ xa. Vui lòng di chuyển tới tiệm.');
			}

			// Submit
			fetch(scriptURL, { method: 'POST', body: formData})
				.then(response => {
					if (response.status == "200") {
						alert("Xác nhận chấm công thành công");

						localStorage.setItem("name", formData.get('Tên'));

						let msg = document.getElementById("successMsg").innerHTML;
						msg = msg.replace("[status]", formData.get('Vào/Tan Ca'));
						msg = msg.replace("[time]", getFormattedNow());
						msg = msg.replace("[shopName]", shopCode2Name[shopCode]);
						document.getElementById("successMsg").innerHTML = msg;

						var gUrlEl = document.getElementById("gmapUrl");
						gUrlEl.innerHTML = googleMapUrl;
						gUrlEl.href = googleMapUrl;
						document.getElementById("message").style.display = "block";
						submitBtn.style.display = "none";
						document.getElementById("spinning").style.display = "none";
					} else {
						alert("Chấm công thất bại")
						window.location.reload();
					}
				})
				.catch(error => console.error('Error!', error.message))
		}

		function getFormattedNow() {
			const date = new Date(); // Assuming the current date and time

			const day = String(date.getDate()).padStart(2, '0');
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const year = date.getFullYear();
			const hour = String(date.getHours()).padStart(2, '0');
			const minute = String(date.getMinutes()).padStart(2, '0');

			const formattedDate = `${day}/${month}/${year} ${hour}:${minute}`;

			return formattedDate;
		}

		function calculateDistance(lat1, lon1, lat2, lon2) {
			const earthRadius = 6371; // Radius of the Earth in kilometers

			// Convert latitude and longitude from degrees to radians
			const lat1Rad = degreesToRadians(lat1);
			const lon1Rad = degreesToRadians(lon1);
			const lat2Rad = degreesToRadians(lat2);
			const lon2Rad = degreesToRadians(lon2);

			// Calculate the differences between the latitudes and longitudes
			const latDiff = lat2Rad - lat1Rad;
			const lonDiff = lon2Rad - lon1Rad;

			// Use the Haversine formula to calculate the distance
			const a =
				Math.sin(latDiff / 2) * Math.sin(latDiff / 2) +
				Math.cos(lat1Rad) *
				Math.cos(lat2Rad) *
				Math.sin(lonDiff / 2) *
				Math.sin(lonDiff / 2);
			const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

			// Calculate the distance in meters
			const distance = earthRadius * c * 1000;

			return distance;
		}

		// Helper function to convert degrees to radians
		function degreesToRadians(degrees) {
			return (degrees * Math.PI) / 180;
		}

	</script>
</body>
</html>
