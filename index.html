<!DOCTYPE html>
<html>
<head>
	<style>
		*{
			box-sizing: border-box;
			padding: 0;
			margin: 0;
			font-family: 'poppins', sans-serif;
			font-size: 18px;
		}
		body{
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.container{
			width: calc(var(--vh, 1vh) * 100);
			padding: 30px;
			margin: 4px;
			border: 1px solid #eeeeee;
			border-radius: 10px;
			background-color: #04a346;
		}
		h4{
			margin-bottom: 10px;
			font-size: 24px;
			color: white;
		}
		input{
			width: 100%;
			padding: 10px;
			margin-bottom: 10px;
			border-radius: 5px;
		}
		select{
			width: 25%;
			padding: 10px;
			margin-bottom: 10px;
			border-radius: 5px;
		}
		textarea{
			width: 100%;
			padding: 10px;
			border-radius: 5px;
		}
		#submit{
			border: none;
			background-color: rgb(12, 80, 4);
			color: white;
			width: 25%;
			margin-top: 10px;
			border-radius: 5px;
		}
		#submit:hover{
			background-color: #0b3b06;
		}
		#message{
			color: white;
		}
	</style>
</head>
<body>
	<div class="container">
		<form method="post" action="" name="contact-form">
			<h4>Giặt Sấy Ori</h4>
			<input type="text" name="Tên" placeholder="Tên nhân viên">
			<select name="Vào/Tan Ca" style="height: 50px">
				<option value="Vào Ca">Vào Ca</option>
				<option value="Tan Ca">Tan Ca</option>
			</select>

			<textarea name="Ghi chú của nhân viên (nếu có)" rows="7" placeholder="Ghi chú của nhân viên (nếu có)"></textarea>
			<input id="submitLocation" type="Nơi chấm công" name="Nơi chấm công" placeholder="Nơi chấm công" style="display: none">
			<div id="message" style="display: none;">
				<div>Xác nhận chấm công thành công tại:</div>
				<a id="gmapUrl" href="" style="color: white"></a>
			</div>
			<input type="submit" value="Gửi" id="submit">
		</form>
	</div>

	<script>
		const MAX_DISTANCE = 150; // meters
		const shopLocations = [
			{
				lat: 10.0416514, // shop 1 To Hien Thanh
				lng: 105.7553143
			},
			{
				lat: 10.0487630, // shop 2 Nguyen De
				lng: 105.7634580
			}
		]
		const scriptURL = 'https://script.google.com/macros/s/AKfycbwRQ_DwN5xaak--miZkQp-JCwiC2aQP8EHb93nxuwoaaAptkeoE57TlqDPHkYigLyUf/exec'

		const submitLocation = document.getElementById("submitLocation");
		const form = document.forms['contact-form'];

		form.addEventListener('submit', e => {
			e.preventDefault()
			getLocation()
		})

		function getLocation() {
			if (navigator.geolocation) {
				try {
					navigator.geolocation.getCurrentPosition(fillPositionAndSubmit);
				}
				catch(err) {
					// not sure this work
					alert("Không thể truy cập vị trí. Vui lòng cho phép truy cập.");
				}
			} else {
				// not sure this work
				alert("Thiết bị không hỗ trợ vị trí, vui lòng thử lại với trình duyệt khác (Safari, Chrome hoặc Firefox)");
			}
		}

		function fillPositionAndSubmit(position) {
			var curLat = position.coords.latitude;
			var curLng = position.coords.longitude;
			
			var googleMapUrl = 'https://maps.google.com/?q='+curLat+','+curLng+'';
			submitLocation.value = googleMapUrl;

			var formData = new FormData(form);
			if (formData.get('Tên') === undefined || formData.get('Tên') === null || formData.get('Tên').trim() === "") {
				alert("Vui lòng điền Tên nhân viên");
				throw new Error('Vui lòng điền Tên nhân viên');
				window.location.reload();
			} else {
				// Verify device location
				var hasValidLocation = false;
				for (let i = 0; i < shopLocations.length; i++) {
					var shopLocation = shopLocations[i];
					var distance = calculateDistance(curLat, curLng, shopLocation.lat, shopLocation.lng); // meters
					if (distance < MAX_DISTANCE) {
						hasValidLocation = true;
					}
				}
				if (!hasValidLocation) {
					alert("Chưa tới tiệm mà dám chấm công he >_< \nĐi làm mau lên, ăn roi giờ!!!");
					throw new Error('Chưa tới tiệm mà dám chấm công he >_< !!! \nĐi làm mau lên, ăn roi giờ!');
					window.location.reload();
				}

				// Submit
				fetch(scriptURL, { method: 'POST', body: formData})
					.then(response => {
						if (response.status == "200") {
							alert("Xác nhận chấm công thành công");
							var gUrlEl = document.getElementById("gmapUrl");
							gUrlEl.innerHTML = googleMapUrl;
							gUrlEl.href = googleMapUrl;
							document.getElementById("message").style.display = "block";
							document.getElementById("submit").style.display = "none";
						} else {
							alert("Chấm công thất bại")
							window.location.reload();
						}
					})
					.catch(error => console.error('Error!', error.message))
			}
		}

		function calculateDistance(lat1, lon1, lat2, lon2) {
			const earthRadius = 6371; // Radius of the Earth in kilometers

			// Convert latitude and longitude from degrees to radians
			const lat1Rad = degreesToRadians(lat1);
			const lon1Rad = degreesToRadians(lon1);
			const lat2Rad = degreesToRadians(lat2);
			const lon2Rad = degreesToRadians(lon2);

			// Calculate the differences between the latitudes and longitudes
			const latDiff = lat2Rad - lat1Rad;
			const lonDiff = lon2Rad - lon1Rad;

			// Use the Haversine formula to calculate the distance
			const a =
				Math.sin(latDiff / 2) * Math.sin(latDiff / 2) +
				Math.cos(lat1Rad) *
				Math.cos(lat2Rad) *
				Math.sin(lonDiff / 2) *
				Math.sin(lonDiff / 2);
			const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

			// Calculate the distance in meters
			const distance = earthRadius * c * 1000;

			return distance;
		}

		// Helper function to convert degrees to radians
		function degreesToRadians(degrees) {
			return (degrees * Math.PI) / 180;
		}

	</script>
</body>
</html>
